- id: deploy-spring-boot-app
  name: Deploy Secure Spring Boot Application
  description: Create a production-ready Spring Boot application with secure database and storage
  on:
  pipeline_call: 
    inputs:
    - name: app_name
      type: string
      required: true
    - name: code_template
      type: string
      default: us-bootstrap
      options: 
        - eu-bootstrap
        - us-bootstrap
        - jp-bootstrap
        - uk-bootstrap
    - name: environment
      type: string
      default: development
      options: 
        - development
        - staging
        - production
  jobs:
    - id: image-from-repo
      path: ext-build
      params: {{ inputs.code_template }}
  
    - id: create-app
      path: create-app
      params:
        name: {{ inputs.app_name }}-{{ inputs.environment }}
    
    - id: add-postgres
      path: add-resource
      params:
        type: postgres
        class: production
        id: {{ previous.create-app.app_name }}.{{ previous.create-app.environment}}.db
        app: {{ previous.create-app.app_name }}
        version: 14
        size: medium
        encryption: true
        backup:
          enabled: true
          frequency: daily
          
    - id: add-storage
      path: add-resource
      params:
        type: persistent-volume
        class: production
        id: {{ previous.create-app.app_name }}.{{ previous.create-app.environment}}.volume
        app: {{ previous.create-app.app_name }}
        size: 50Gi
        access_mode: ReadWriteOnce
    
    - id: deploy
      path: deploy
      params:
        app: {{ previous.create-app.app_name }}
        image: {{ steps.image-from-repo.outputs.conclusion }}
    
    - id: configure-secrets
      path: create_secret
      params:
        namespace: {{ previous.create-app.app_name }}
        secrets:
          - key: DATABASE_URL
            value: {{ previous.provision-postgres.connection_string }}
          - key: JWT_SECRET
            generate: true